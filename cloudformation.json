{
	"Parameters": {
		"BucketName": {
			"Type": "String"
		}
	},

	"Resources": {
		"Bucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"AccessControl": "PublicRead",
				"BucketEncryption": {
					"ServerSideEncryptionConfiguration": [ {
						"BucketKeyEnabled": true,
						"ServerSideEncryptionByDefault": {
							"SSEAlgorithm": "AES256"
						}
					} ]
				},
				"BucketName": { "Ref": "BucketName" },
				"LifecycleConfiguration": {
					"Rules": [ {
						"AbortIncompleteMultipartUpload": {
							"DaysAfterInitiation": 1
						},
						"ExpiredObjectDeleteMarker": true,
						"Id": "Permanently Delete Noncurrent Versions",
						"NoncurrentVersionExpirationInDays": 1,
						"Status": "Enabled"
					} ]
				},
				"LoggingConfiguration": {
					"DestinationBucketName": { "Ref": "LoggingBucket" },
					"LogFilePrefix": { "Fn::Sub": "${BucketName}/" }
				},
				"VersioningConfiguration": { "Status": "Enabled" },
				"WebsiteConfiguration": {
					"ErrorDocument": "error.html",
					"IndexDocument": "index.html"
				}
			}
		},

		"BucketPolicy": {
			"Type": "AWS::S3::BucketPolicy",
			"Properties": {
				"Bucket": { "Ref": "Bucket" },
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Sid": "PublicReadGetObject",
							"Effect": "Allow",
							"Principal": "*",
							"Action": "s3:GetObject",
							"Resource": { "Fn::Sub": "arn:aws:s3:::${Bucket}/*" }
						},
						{
							"Sid": "DenyUnEncryptedObjectUploads",
							"Effect": "Deny",
							"Principal": "*",
							"Action": "s3:PutObject",
							"Resource": { "Fn::Sub": "arn:aws:s3:::${Bucket}/*" },
							"Condition": {
								"Null": {
									"s3:x-amz-server-side-encryption": "true"
								}
							}
						},
						{
							"Sid": "DenyIncorrectEncryptionHeader",
							"Effect": "Deny",
							"Principal": "*",
							"Action": "s3:PutObject",
							"Resource": { "Fn::Sub": "arn:aws:s3:::${Bucket}/*" },
							"Condition": {
								"StringNotEquals": {
									"s3:x-amz-server-side-encryption": "AES256"
								}
							}
						}
					]
				}
			}
		},

		"LoggingBucket": {
			"Type": "AWS::S3::Bucket",
			"Properties": {
				"AccessControl": "LogDeliveryWrite",
				"BucketEncryption": {
					"ServerSideEncryptionConfiguration": [ {
						"BucketKeyEnabled": true,
						"ServerSideEncryptionByDefault": {
							"SSEAlgorithm": "AES256"
						}
					} ]
				},
				"BucketName": { "Fn::Sub": "${BucketName}-logs" },
				"LifecycleConfiguration": {
					"Rules": [ {
						"AbortIncompleteMultipartUpload": {
							"DaysAfterInitiation": 1
						},
						"ExpirationInDays": 7,
						"Id": "Delete Current and Permanently Delete Noncurrent Versions",
						"NoncurrentVersionExpirationInDays": 1,
						"Status": "Enabled"
					} ]
				}
			}
		}
	},

	"Outputs": {
		"S3WebsiteURL": {
			"Value": { "Fn::GetAtt": [ "Bucket", "WebsiteURL" ] },
			"Description": "URL for website hosted on S3"
		},

		"S3BucketSecureURL": {
			"Value": { "Fn::Join": [ "", [
				"https://",
				{ "Fn::GetAtt": [ "Bucket", "DomainName" ] },
				"/index.html"
			] ] },
			"Description": "HTTPS endpoint of index page in bucket"
		}
	}
}
